name: Rollback Tag Dry-Run (no AWS)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "explicit=ì…ë ¥ íƒœê·¸ ì‚¬ìš©, previous=ì´ì „ íƒœê·¸ ìë™ ì„ íƒ"
        type: choice
        required: true
        options: [explicit, previous]
      tag:
        description: "mode=explicitì¼ ë•Œ ì‚¬ìš©í•  íƒœê·¸ (ì˜ˆ: v1.2.3)"
        required: false
      active_tag:
        description: "í˜„ì¬ í™œì„± íƒœê·¸ (previous ì‹œë®¬ë ˆì´ì…˜ìš©)"
        required: false
        default: "v1.1.0"
      releases:
        description: "ê°€ìš© íƒœê·¸ ëª©ë¡(ì‰¼í‘œ êµ¬ë¶„) â€” previous ì‹œë®¬ë ˆì´ì…˜ìš©"
        required: false
        default: "v1.0.0,v1.1.0,v1.2.0"

jobs:
  dry_run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Pick target tag (no AWS)
        id: pick
        shell: bash
        run: |
          set -euo pipefail
          MODE="${{ inputs.mode }}"
          INPUT_TAG="${{ inputs.tag }}"
          ACTIVE="${{ inputs.active_tag }}"
          RELEASES_RAW="${{ inputs.releases }}"

          # ì‰¼í‘œ êµ¬ë¶„ ëª©ë¡ì„ ë°°ì—´ë¡œ íŒŒì‹±
          IFS=',' read -ra ARR <<< "$RELEASES_RAW"

          if [[ "$MODE" == "explicit" ]]; then
            if [[ -z "${INPUT_TAG:-}" ]]; then
              echo "âŒ mode=explicit ì´ë©´ tag ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤." >&2
              exit 1
            fi
            TARGET="$INPUT_TAG"
          else
            TARGET=""
            # ë‹¨ìˆœ ì‹œë®¬: releasesì—ì„œ activeì™€ ë‹¤ë¥¸ ì²« í•­ëª©ì„ ì´ì „ íƒœê·¸ë¡œ ê°„ì£¼
            for t in "${ARR[@]}"; do
              trimmed="$(echo "$t" | xargs)"  # ì•ë’¤ ê³µë°± ì œê±°
              if [[ "$trimmed" != "$ACTIVE" ]]; then
                TARGET="$trimmed"
                break
              fi
            done
            if [[ -z "$TARGET" ]]; then
              echo "âŒ previous ëª¨ë“œì—ì„œ ì´ì „ íƒœê·¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤." >&2
              exit 1
            fi
          fi

          echo "target_tag=$TARGET" >> "$GITHUB_OUTPUT"

          # Step Summaryì— ë³´ê¸° ì¢‹ê²Œ ì¶œë ¥
          {
            echo "## ğŸ” Rollback Tag Dry-Run"
            echo ""
            echo "| í•­ëª© | ê°’ |"
            echo "|---|---|"
            echo "| ëª¨ë“œ | $MODE |"
            echo "| Active íƒœê·¸ | $ACTIVE |"
            echo "| Releases | $RELEASES_RAW |"
            echo "| **ì„ íƒëœ íƒœê·¸** | **$TARGET** |"
          } >> "$GITHUB_STEP_SUMMARY"

          # ë¡œê·¸ì—ë„ ëˆˆì— ë„ê²Œ í‘œì‹œ
          echo "::notice title=Selected tag::$TARGET"

      - name: Show result
        run: |
          echo "Selected tag (output) = ${{ steps.pick.outputs.target_tag }}"
