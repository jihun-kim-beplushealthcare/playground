name: Rollback static site (S3 + CloudFront)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "ë¡¤ë°± ëŒ€ìƒ ì„ íƒ"
        type: choice
        required: true
        options:
          - explicit # ì…ë ¥í•œ íƒœê·¸ë¡œ ì „í™˜
          - previous # í˜„ì¬ í™œì„± ë²„ì „ì˜ ì§ì „ íƒœê·¸ë¡œ ì „í™˜
      tag:
        description: "mode=explicit ì¼ ë•Œ /releases/<ì—¬ê¸°> ë¡œ ì „í™˜ (ì˜ˆ: v1.2.3)"
        required: false
      invalidate_html:
        description: "index.html ìºì‹œ ë¬´íš¨í™” ìˆ˜í–‰"
        type: boolean
        default: true
        required: true
      dry_run:
        description: "ì„¤ì • ë³€ê²½ ì—†ì´ ê²€ì¦ë§Œ ìˆ˜í–‰"
        type: boolean
        default: false
        required: true
      bump_version:
        description: "ë¸Œëœì¹˜ ê·œì¹™ì— ë”°ë¼ package.json ë²„ì „ ìë™ ì¦ê°€"
        type: boolean
        default: false
        required: true
      tag_release:
        description: "ë²„ì „ ì¦ê°€ ì‹œ git íƒœê·¸ê¹Œì§€ ìƒì„±/í‘¸ì‹œ"
        type: boolean
        default: false
        required: true

permissions:
  id-token: write
  contents: write # â¬…ï¸ ë²„ì „ ì»¤ë°‹/í‘¸ì‹œ ìœ„í•´ write ë¡œ ë³€ê²½

env:
  AWS_REGION: ap-northeast-2
  S3_BUCKET: your-s3-bucket-name # ğŸ” ë°”ê¾¸ì„¸ìš”
  RELEASES_PREFIX: releases/
  CLOUDFRONT_DISTRIBUTION_ID: E123ABCDEF0123 # ğŸ” ë°”ê¾¸ì„¸ìš”
  CLOUDFRONT_ORIGIN_ID: s3-origin # ğŸ” Origins.items[].Id
  AWS_ACCOUNT_ID: "123456789012" # ğŸ” ë°”ê¾¸ì„¸ìš”
  AWS_ROLE_NAME: "github-actions-oidc-role" # ğŸ” ë°”ê¾¸ì„¸ìš”

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------- (ì˜µì…˜) ë²„ì „ ìë™ ì¦ê°€ ë¸”ë¡ ----------
      - name: Setup Node
        if: ${{ inputs.bump_version }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Pick bump type (main=major, develop/release=minor, else=patch)
        if: ${{ inputs.bump_version }}
        id: pick_bump
        run: |
          BRANCH="${{ github.ref_name }}"
          case "$BRANCH" in
            main) BUMP="major" ;;
            develop|release) BUMP="minor" ;;
            *) BUMP="patch" ;;
          esac
          echo "bump=$BUMP" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      # (íƒœê·¸ ì—†ì´) ë²„ì „ë§Œ ì˜¬ë¦¬ê³  ìˆ˜ë™ ì»¤ë°‹/í‘¸ì‹œ
      - name: Bump package.json (no tag)
        if: ${{ inputs.bump_version && !inputs.tag_release }}
        # working-directory: apps/your-app   # â¬…ï¸ ëª¨ë…¸ë ˆí¬ë©´ ê²½ë¡œ ì§€ì •
        run: |
          npm version ${{ steps.pick_bump.outputs.bump }} --no-git-tag-version
          echo "NEW_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: Commit & push version bump
        if: ${{ inputs.bump_version && !inputs.tag_release }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json 2>/dev/null || true
          git commit -m "chore(version): bump to v${NEW_VERSION} on ${{ steps.pick_bump.outputs.branch }} (${{ steps.pick_bump.outputs.bump }})" || exit 0
          git push origin "HEAD:${{ github.ref_name }}"

      # (íƒœê·¸ í¬í•¨) npm versionì´ ìë™ ì»¤ë°‹+íƒœê·¸ë¥¼ ë§Œë“­ë‹ˆë‹¤
      - name: Bump & tag release
        if: ${{ inputs.bump_version && inputs.tag_release }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          npm version ${{ steps.pick_bump.outputs.bump }} -m "chore(release): v%s"

      - name: Push with tags
        if: ${{ inputs.bump_version && inputs.tag_release }}
        run: |
          git push origin "HEAD:${{ github.ref_name }}" --follow-tags
      # ---------- (ì˜µì…˜) ë²„ì „ ìë™ ì¦ê°€ ë¸”ë¡ ë ----------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.AWS_ROLE_NAME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install jq (awscliëŠ” ì´ë¯¸ì§€ì— ê¸°ë³¸ í¬í•¨)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Read active CloudFront OriginPath
        id: active
        run: |
          TMP=$(mktemp)
          aws cloudfront get-distribution --id "${CLOUDFRONT_DISTRIBUTION_ID}" > "$TMP"
          ACTIVE_ORIGIN_PATH=$(
            jq -r --arg OID "${CLOUDFRONT_ORIGIN_ID}" \
              '.Distribution.DistributionConfig.Origins.Items[]
               | select(.Id == $OID).OriginPath' "$TMP"
          )
          echo "active_origin_path=${ACTIVE_ORIGIN_PATH}" >> "$GITHUB_OUTPUT"
          echo "â„¹ï¸ Active OriginPath: ${ACTIVE_ORIGIN_PATH}"

      - name: Pick target tag
        id: pick
        run: |
          set -euo pipefail
          MODE="${{ inputs.mode }}"
          INPUT_TAG="${{ inputs.tag }}"
          ACTIVE_PATH="${{ steps.active.outputs.active_origin_path }}"
          ACTIVE_TAG=$(echo "$ACTIVE_PATH" | awk -F'/' '{print $3}')

          if [ "$MODE" = "explicit" ]; then
            if [ -z "$INPUT_TAG" ]; then
              echo "âŒ mode=explicit ì¼ ë•ŒëŠ” tag ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤." >&2
              exit 1
            fi
            TARGET_TAG="$INPUT_TAG"
          else
            LIST=$(aws s3 ls "s3://${S3_BUCKET}/${RELEASES_PREFIX}" | awk '{print $2}' | sed 's#/##')
            if [ -z "$LIST" ]; then
              echo "âŒ releases/ í•˜ìœ„ì— íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤." >&2
              exit 1
            fi
            TARGET_TAG=""
            for rel in $(echo "$LIST" | sort -r); do
              if [ "$rel" != "$ACTIVE_TAG" ]; then
                TARGET_TAG="$rel"
                break
              fi
            done
            if [ -z "$TARGET_TAG" ]; then
              echo "âŒ í™œì„± íƒœê·¸ ì™¸ì˜ ì´ì „ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤." >&2
              exit 1
            fi
          fi

          if ! aws s3 ls "s3://${S3_BUCKET}/${RELEASES_PREFIX}${TARGET_TAG}/index.html" >/dev/null 2>&1; then
            echo "âŒ ëŒ€ìƒ íƒœê·¸ì— index.html ì´ ì—†ìŠµë‹ˆë‹¤: s3://${S3_BUCKET}/${RELEASES_PREFIX}${TARGET_TAG}/index.html" >&2
            exit 1
          fi

          echo "target_tag=${TARGET_TAG}" >> "$GITHUB_OUTPUT"
          echo "ğŸ¯ Target tag: ${TARGET_TAG}"

      - name: Show planned change
        run: |
          echo "í˜„ì¬ OriginPath: ${{ steps.active.outputs.active_origin_path }}"
          echo "ë³€ê²½ë  OriginPath: /${{ env.RELEASES_PREFIX }}${{ steps.pick.outputs.target_tag }}"

      - name: Stop here (dry-run)
        if: ${{ inputs.dry_run == true }}
        run: echo "ğŸŸ¨ Dry-run ëª¨ë“œë¡œ ì„¤ì • ë³€ê²½ ì—†ì´ ì¢…ë£Œí•©ë‹ˆë‹¤."

      - name: Switch CloudFront OriginPath
        if: ${{ inputs.dry_run == false }}
        run: |
          set -euo pipefail
          NEW_PATH="/${RELEASES_PREFIX}${{ steps.pick.outputs.target_tag }}"
          TMPCFG=$(mktemp)
          aws cloudfront get-distribution-config --id "${CLOUDFRONT_DISTRIBUTION_ID}" > "$TMPCFG"
          ETAG=$(jq -r '.ETag' "$TMPCFG")
          CFG=$(jq -r '.DistributionConfig' "$TMPCFG")

          NEW_CFG=$(echo "$CFG" | jq --arg OID "${CLOUDFRONT_ORIGIN_ID}" --arg PATH "$NEW_PATH" '
            .Origins.Items |= map(if .Id == $OID then .OriginPath = $PATH else . end)
          ')
          echo "$NEW_CFG" > distribution-config.json

          aws cloudfront update-distribution \
            --id "${CLOUDFRONT_DISTRIBUTION_ID}" \
            --if-match "$ETAG" \
            --distribution-config file://distribution-config.json

          echo "âœ… OriginPath switched to ${NEW_PATH}"

      - name: Invalidate /index.html
        if: ${{ inputs.dry_run == false && inputs.invalidate_html == true }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${CLOUDFRONT_DISTRIBUTION_ID}" \
            --paths "/index.html"
          echo "ğŸ§¹ Created invalidation for /index.html"

      - name: Summary
        if: ${{ always() }}
        run: |
          echo "Active(before): ${{ steps.active.outputs.active_origin_path }}"
          echo "Target tag    : ${{ steps.pick.outputs.target_tag }}"
          echo "Dry-run       : ${{ inputs.dry_run }}"
          echo "Invalidate    : ${{ inputs.invalidate_html }}"
          echo "Bump version  : ${{ inputs.bump_version }}"
          echo "Tag release   : ${{ inputs.tag_release }}"
